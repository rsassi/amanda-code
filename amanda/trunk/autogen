#! /bin/sh
# rebuilds files generated by autoconf&automake.
# autoconf 2.13 and automake 1.4 or newer are required
# arguments are forwarded to the autoreconf script.

# cd to the directory we're run from
cd `dirname $0`

# if you change this, please also change it in the root Makefile.am
includes="-I . -I config -I config/gettext-macros -I config/gnulib -I config/amanda -I config/macro-archive"

# clean up
rm -f aclocal.m4
rm -rf autom4te*.cache
rm -f configure

die() {
    echo x"${@}" | sed s/^x//
    exit 1
}

echo "See docs/developing.txt for instructions on updating:"
echo " * gettext macros"
echo " * gnulib"
echo " * libtool files"

echo "..creating file lists"
(   cd config
    for m4dir in amanda gettext-macros gnulib macro-archive; do
	echo "## this file is automatically generated by autogen" > "$m4dir/file-list"
	for f in $m4dir/*.m4; do echo "EXTRA_DIST += $f" >> "$m4dir/file-list"; done
    done

    echo "## this file is automatically generated by autogen" > "automake/file-list"
    for f in automake/*.am; do echo "EXTRA_DIST += $f" >> "automake/file-list"; done
)

echo "..aclocal"
aclocal $includes || die "aclocal failed"

echo "..autoconf"
autoconf || die "autoconf failed"

echo "..autoheader"
autoheader || die "autoheader failed"
touch config/config.h.in

echo "..automake"
automake --add-missing --force --copy --warnings=none || die "automake failed"
